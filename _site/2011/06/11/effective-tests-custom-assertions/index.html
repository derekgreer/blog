<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/normalize.css"/>
  <link rel="stylesheet" href="/assets/css/bulma.css"/>
  <link rel="stylesheet" href="/assets/css/highlight.css"/>
  <link rel="stylesheet" href="/assets/css/custom.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">

  <!-- Icons -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/AspiringCraftsman">

  <title>
    
      Effective Tests: Custom Assertions &middot; Aspiring Craftsman
    
  </title>

</head>


<body>

<section class="hero is-dark">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">Aspiring Craftsman</h1><div>pursuing well-crafted software</div>
<!--
          <span class="typewrite" data-period="2000" data-type='[ "pursuing well-crafted software"]'>
            <span class="wrap"></span>
          </span>
-->
      <!--
      <h4 class="subtitle" id="quote">
      </h4>
      -->
    </div>
  </div>
</section>

<div class="main-container">
  <div class="tile is-ancestor is-vertical">


    <nav class="nav has-shadow">

      <div class="nav-left">

        <a href="/" class="nav-item">
          <span class="icon">
            <i class="fa fa-home" aria-hidden="true" title="Homepage"></i>
          </span>
        </a>

        <a href="https://github.com/derekgreer" class="nav-item">
          <span class="icon">
            <i class="fa fa-github" aria-hidden="true" title="Github"></i>
          </span>
        </a>

        <div class="nav-item" id="searchFieldNav">
          <div class="field has-addons">
            <p class="control">
              <input class="input is-small" type="text" placeholder="Find an article" id="search-text">
            </p>
            <p class="control">
              <a class="button is-dark is-small" onclick="searchHandler();">
                Search
              </a>
            </p>
          </div>
        </div>

      </div>

      <div class="nav-right nav-menu" id='nav-menu'>
        <a href="/archive" class="nav-item">Archive</a>
        <a href="/tags" class="nav-item">Tags</a>
        <a href="/about" class="nav-item">About</a>
        <a href="http://feeds.feedburner.com/AspiringCraftsman" class="nav-item"><img src="/assets/images/rss.png"/></a>
      </div>

      <span class="nav-toggle" id="nav-toggle">
          <span></span>
          <span></span>
          <span></span>
    </nav>

    <div class="tile is-parent">
      <div class="tile is-8 is-child main">

        <div class="box">
    <h1 class="post-title">Effective Tests: Custom Assertions</h1>
    <span class="post-meta">11 June, 2011. It was a Saturday. <a style="color:grey" href="#disqus_thread"></a></span><hr/>

    <span class="post-text"><p>In <noindex></noindex> our <a href="http://www.aspiringcraftsman.com/2011/05/31/effective-tests-auto-mocking-containers/">last installment</a>, we took a look at using Auto-mocking Containers as a way of reducing coupling and obscurity within our tests. This time, we’ll take a look at another technique which aids in preventing obscurity caused by complex assertions: Custom Assertions.</p>

<h2 id="custom-assertions">Custom Assertions</h2>

<p>As discussed earlier in the series, executable specifications are a model for our requirements. Whether serving as a guide for our implementation or as documentation for existing behavior, specifications should be easy to understand. Assertion implementation is one of the areas that can often begin to obscure the intent of our specifications. When standard assertions fall short of expressing what is being validated clearly and concisely, they can be replaced with <em>Custom Assertions</em>. Custom assertions are domain-specific assertions which encapsulate complex or obscure testing logic within intention-revealing methods.</p>

<p>Consider the following example which validates that the items returned from a ReviewService class are sorted in descending order:</p>

<pre class="brush:csharp; gutter:false; wrap-lines:false; tab-size:2;">public class when_a_customer_retrieves_comment_history : WithSubject&lt;ReviewService&gt;
    {
        const string ItemId = "123";
        static IEnumerable&lt;Comment&gt; _comments;

        Establish context = () =&gt; For&lt;IItemRepository&gt;()
                                      .Setup(x =&gt; x.Get(ItemId))
                                      .Returns(new Item(new[]
                                                            {
                                                                new Comment("comment 1", DateTime.MinValue.AddDays(1)),
                                                                new Comment("comment 2", DateTime.MinValue.AddDays(2)),
                                                                new Comment("comment 3", DateTime.MinValue.AddDays(3))
                                                            }));

        Because of = () =&gt; _comments = Subject.GetCommentsForItem(ItemId);
      
        It should_return_comments_sorted_by_date_in_descending_order = () =&gt;
            {
                Comment[] commentsArray = _comments.ToArray();
                for (int i = commentsArray.Length - 1; i &gt; 0; i--)
                {
                    if (commentsArray[i].TimeStamp &gt; commentsArray[i - 1].TimeStamp)
                    {
                        throw new Exception(
                            string.Format(
                                "Expected comments sorted in descending order, but found comment \'{0}\' on {1} after \'{2}\' on {3}",
                                commentsArray[i].Text, commentsArray[i].TimeStamp, commentsArray[i - 1].Text,
                                commentsArray[i - 1].TimeStamp));
                    }
                }
            };
    }</pre>

<p> </p>

<p>While the identifiers used to describe the specification are clear, the observation’s implementation contains a significant amount of verification logic which makes the specification more difficult to read. By moving the verification logic into a custom assertion which describes what is expected, we can clarify the specification’s intent.</p>

<p>When developing on the .Net platform, <a href="http://en.wikipedia.org/wiki/Extension_method">Extension Methods</a> provide a nice way of encapsulating assertion logic while achieving an expressive API. The following listing shows the same assertion logic contained within an extension method:</p>

<pre class="brush:csharp; gutter:false; wrap-lines:false; tab-size:2;">public static class CustomAssertions
    {
        public static void ShouldBeSortedByDateInDescendingOrder(this IEnumerable&lt;Comment&gt; comments)
        {
            Comment[] commentsArray = comments.ToArray();
            for (int i = commentsArray.Length - 1; i &gt; 0; i--)
            {
                if (commentsArray[i].TimeStamp &gt; commentsArray[i - 1].TimeStamp)
                {
                    throw new Exception(
                        string.Format(
                            "Expected comments sorted in descending order, but found comment \'{0}\' on {1} after \'{2}\' on {3}",
                            commentsArray[i].Text, commentsArray[i].TimeStamp, commentsArray[i - 1].Text,
                            commentsArray[i - 1].TimeStamp));
                }
            }
        }
    }</pre>

<p> </p>

<p>Using this new custom assertion, the specification can be rewritten to be more intention-revealing:</p>

<pre class="brush:csharp; gutter:false; wrap-lines:false; tab-size:2;">public class when_a_customer_retrieves_comment_history : WithSubject&lt;ReviewService&gt;
    {
        const string ItemId = "123";
        static IEnumerable&lt;Comment&gt; _comments;

        Establish context = () =&gt; For&lt;IItemRepository&gt;()
                                      .Setup(x =&gt; x.Get(ItemId))
                                      .Returns(new Item(new[]
                                                            {
                                                                new Comment("comment 1", DateTime.MinValue.AddDays(1)),
                                                                new Comment("comment 2", DateTime.MinValue.AddDays(2)),
                                                                new Comment("comment 3", DateTime.MinValue.AddDays(3))
                                                            }));

        Because of = () =&gt; _comments = Subject.GetCommentsForItem(ItemId);

        It should_return_comments_sorted_by_date_in_descending_order = () =&gt; _comments.ShouldBeSortedByDateInDescendingOrder();
    }</pre>

<h2 id="verifying-assertion-logic">Verifying Assertion Logic</h2>

<p>Another advantage of factoring out complex assertion logic into custom assertion methods is the ability to verify that the logic actually works as expected. This can be particularly valuable if the assertion logic is reused by many specifications.</p>

<p>The following listing shows positive and negative tests for our custom assertion:</p>

<pre class="brush:csharp; gutter:false; wrap-lines:false; tab-size:2;">public class when_asserting_unsorted_comments_are_sorted_in_descending_order
    {
        static Exception _exception;
        static List&lt;Comment&gt; _unsortedComments;

        Establish context = () =&gt;
            {
                _unsortedComments = new List&lt;Comment&gt;
                                        {
                                            new Comment("comment 1", DateTime.MinValue.AddDays(1)),
                                            new Comment("comment 4", DateTime.MinValue.AddDays(4)),
                                            new Comment("comment 3", DateTime.MinValue.AddDays(3)),
                                            new Comment("comment 2", DateTime.MinValue.AddDays(2))
                                        };
            };

        Because of = () =&gt; _exception = Catch.Exception(() =&gt; _unsortedComments.ShouldBeSortedByDateInDescendingOrder());

        It should_throw_an_exception = () =&gt; _exception.ShouldBeOfType(typeof(Exception));
    }

    public class when_asserting_sorted_comments_are_sorted_in_descending_order
    {
        static Exception _exception;
        static List&lt;Comment&gt; _unsortedComments;

        Establish context = () =&gt;
        {
            _unsortedComments = new List&lt;Comment&gt;
                                        {
                                            new Comment("comment 4", DateTime.MinValue.AddDays(4)),
                                            new Comment("comment 3", DateTime.MinValue.AddDays(3)),
                                            new Comment("comment 2", DateTime.MinValue.AddDays(2)),
                                            new Comment("comment 1", DateTime.MinValue.AddDays(1))
                                        };
        };

        Because of = () =&gt; _exception = Catch.Exception(() =&gt; _unsortedComments.ShouldBeSortedByDateInDescendingOrder());

        It should_not_throw_an_exception = () =&gt; _exception.ShouldBeNull();
    }</pre>

<h2 id="conclusion">Conclusion</h2>

<p>This time, we examined a simple strategy for clarifying the intent of our specifications involving the movement of complex verification logic into custom assertions methods. Next time we’ll take a look at another strategy for clarifying the intent of our specifications which also serves to reduce test code duplication and test-specific code within production.</p>
</span>
</div>

<!--<div class="box">-->
    <!-- google ads code box -->
<!--</div>-->




  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'aspiringcraftsman'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>

      <div class="tile is-4 is-child">
        <div class="tile is-parent is-vertical sidebar">

          <div class="tile is-child widget">

            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recent Posts
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <ul>
                  
                  <li><a href="/2017/05/25/hello-react-a-beginners-setup-tutorial/">
                    Hello, React! - A Beginner's Setup Tutorial
                  </a></li>
                  
                  <li><a href="/2016/08/30/exploring-typescript/">
                    Exploring TypeScript
                  </a></li>
                  
                  <li><a href="/2016/08/22/git-on-windows-whence-cometh-configuration/">
                    Git on Windows: Whence Cometh Configuration
                  </a></li>
                  
                  <li><a href="/2016/02/28/separation-of-concerns-application-builds-continuous-integration/">
                    Separation of Concerns: Application Builds & Continuous Integration
                  </a></li>
                  
                  <li><a href="/2015/11/01/survey-of-entity-framework-unit-of-work-patterns/">
                    Survey of Entity Framework Unit of Work Patterns
                  </a></li>
                  
                  <li><a href="/2015/03/08/introducing-nunit-specifications/">
                    Introducing NUnit.Specifications
                  </a></li>
                  
                  <li><a href="/2014/03/05/being-agile/">
                    Being Agile
                  </a></li>
                  
                  <li><a href="/2013/11/17/expected-objects-custom-comparisons/">
                    Expected Objects Custom Comparisons
                  </a></li>
                  
                  <li><a href="/2013/04/17/rabbitbus-an-example/">
                    RabbitBus: An Example
                  </a></li>
                  
                  <li><a href="/2013/01/27/adventures-in-debugging-the-nhibernate-dont-flush-the-session-error/">
                    Adventures in Debugging: The NHibernate 'don't flush the Session' Error
                  </a></li>
                  
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="tile is-child widget">
            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recommended Websites
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <ul>
                    <li>
                      <a href="https://lostechies.com">Los Techies</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>
</div>

<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>
      <a class="icon" href="https://github.com/derekgreer">
          <i class="fa fa-github" title="Github"></i>
        </a>
        <a class="icon" href="https://in.linkedin.com/in/derekgreer">
          <i class="fa fa-linkedin" title="Linkedin"></i>
        </a>
        <a class="icon" href="mailto:dbgreer@gmail.com">
          <i class="fa fa-envelope" title="Email"></i>
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- js -->
<script src="/assets/js/custom.js"></script>
<script src="/assets/js/typewriter.js"></script>
</body>
</html>
