<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/normalize.css"/>
  <link rel="stylesheet" href="/assets/css/bulma.css"/>
  <link rel="stylesheet" href="/assets/css/highlight.css"/>
  <link rel="stylesheet" href="/assets/css/custom.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">

  <!-- Icons -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/AspiringCraftsman">

  <title>
    
      Assembly Resolution with Separate AppDomains &middot; Aspiring Craftsman
    
  </title>

</head>


<body>

<section class="hero is-dark">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">Aspiring Craftsman</h1><div>pursuing well-crafted software</div>
<!--
          <span class="typewrite" data-period="2000" data-type='[ "pursuing well-crafted software"]'>
            <span class="wrap"></span>
          </span>
-->
      <!--
      <h4 class="subtitle" id="quote">
      </h4>
      -->
    </div>
  </div>
</section>

<div class="main-container">
  <div class="tile is-ancestor is-vertical">


    <nav class="nav has-shadow">

      <div class="nav-left">

        <a href="/" class="nav-item">
          <span class="icon">
            <i class="fa fa-home" aria-hidden="true" title="Homepage"></i>
          </span>
        </a>

        <a href="https://github.com/derekgreer" class="nav-item">
          <span class="icon">
            <i class="fa fa-github" aria-hidden="true" title="Github"></i>
          </span>
        </a>

        <div class="nav-item" id="searchFieldNav">
          <div class="field has-addons">
            <p class="control">
              <input class="input is-small" type="text" placeholder="Find an article" id="search-text">
            </p>
            <p class="control">
              <a class="button is-dark is-small" onclick="searchHandler();">
                Search
              </a>
            </p>
          </div>
        </div>

      </div>

      <div class="nav-right nav-menu" id='nav-menu'>
        <a href="/archive" class="nav-item">Archive</a>
        <a href="/tags" class="nav-item">Tags</a>
        <a href="http://feeds.feedburner.com/AspiringCraftsman" class="nav-item"><img src="/assets/images/rss.png"/></a>
      </div>

      <span class="nav-toggle" id="nav-toggle">
          <span></span>
          <span></span>
          <span></span>
    </nav>

    <div class="tile is-parent">
      <div class="tile is-8 is-child main">

        <div class="box">
    <h1 class="post-title">Assembly Resolution with Separate AppDomains</h1>
    <span class="post-meta">25 June, 2007. It was a Monday. <a style="color:grey" href="#disqus_thread"></a></span><hr/>

    <span class="post-text"><p>It’s <noindex></noindex> been quite a while since my last post. This was primarily due to an extremely busy schedule I kept last year and the fact that I relocated for a new job about 6 months ago. This has kept me quite preoccupied in all that goes with getting settled into a new city, job, and home. I thought I’d try to get back into the swing of things by sharing a recent obstacle I encountered involving Assembly resolution.</p>

<p>I recently designed a search framework at my new company which allows for differing teams to develop Add-Ins to provide search capabilities for an existing host application. I’ve designed a number of plug-in frameworks in the past, but this particular application presented me with an interesting challenge.</p>

<p>The issue I encountered involved the loading of Add-In assemblies within the context of a separate AppDomain. Normally this wouldn’t be an issue, but due to a custom assembly loading process used by the host application, my framework encountered problems loading dependency resources required by some of the Add-In assemblies.</p>

<p>The hosting application which my search framework was designed for is itself an Add-In based framework very much like the Composite UI Application Block (and was in fact one of the projects which lead to the development of the CAB by the P&amp;P; team). The host application was designed to load its modules into the load-from context from folders denoting the version number of the module. This was done to allow multiple versions of a single module to be present within a single install of the application. To allow multiple modules to share assemblies, the host application provides a common folder which is interrogated upon the raising of the default AppDomain’s AssemblyResolve event.</p>

<p>Once loaded, my search framework made calls to a reflection utility to find and load its own Add-Ins from a configurable list of folder locations. I designed this utility to search for Add-Ins within a separate AppDomain to prevent the search process from loading assemblies into the default domain solely to interrogate the assemblies for the proper types. Upon successfully completing the search process, the utility returns a list of types to the default domain and unloads the separate domain.</p>

<p>This was all well and good until I attempted to load an Add-In assembly which contained dependencies on assemblies installed in the host application’s special common assembly folder. The default domain could resolve the assembly due to the handler wired to the AssemblyResolve event, but the new AppDomain wasn’t wired to resolve assemblies from this special folder. The result was that the loading of the prospective Add-In assembly failed since all of its dependencies couldn’t be resolved.</p>

<p>There are several potential solutions to such a problem, but the best will depend on your particular application type.</p>

<p>One solution to this issue would be to handle the AssemblyResolve event in the new AppDomain to search the same folders used by the default domain. A shortcoming of this approach would be that it would duplicate code thereby leaving the process open to becoming out of sync with the default domain’s process. The potential for this problem becomes more likely for composite applications where different components of the application are maintained by multiple development teams. Because this involves the duplication of code, this solution would not be advised.</p>

<p>Another approach would be to use the same AssemblyResolve event handler used by the default domain to resolve assemblies for the new AppDomain. Of course, this would first presume the event handler was publically accessible to the reflection utility code. This might be an acceptable solution for applications maintained by a single development team, but would be somewhat fragile for composite applications maintained by multiple teams. The shortcoming of this approach is that building in such a dependency would lead to future incompatibility errors if the default domain’s process changed the name or accessibility of the handler in a future release.</p>

<p>Both of these options have the advantage of containing the load process within the context of the new AppDomain, but have similar disadvantages in their dependencies on the default domain’s loading process.</p>

<p>The solution I settled on was to handle the AssemblyResolve event in the new AppDomain, but to marshal the resolution process back to the default AppDomain. I did this by first providing a reference to the default AppDomain from the code running in the new AppDomain. I then used the DoCallback() method of the default AppDomain from within my new AssemblyResolve handler to call a method which performed a simple Assembly.Load() on the missing assembly. Because the code was running in the default AppDomain, it triggered the handler registered by the hosting application since the assembly didn’t exist in the GAC or the application’s bin folder. I then used the SetData() and GetData() methods on the default AppDomain reference to store and retrieve the resulting assembly’s codebase and was then able to load the assembly into the load-from context from the new domain.</p>

<p>The drawback to this approach is that it does still carry with it a minimal potential of loading assemblies into the default domain which would not otherwise have been loaded during the lifetime of the executing process. This would happen if a non-matching assembly was interrogated by the Add-In search process which had a dependency on a shared assembly in one of the special folders provided by the host application, but which would not have otherwise been loaded for some other reason … a rare case in my situation. Overall, this was the most robust solution for my particular needs.</p>
</span>
</div>

<!--<div class="box">-->
    <!-- google ads code box -->
<!--</div>-->




  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'aspiringcraftsman'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>

      <div class="tile is-4 is-child">
        <div class="tile is-parent is-vertical sidebar">

          <div class="tile is-child widget">

            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recent Posts
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <ul>
                  
                  <li><a href="/2017/05/25/hello-react-a-beginners-setup-tutorial/">
                    Hello, React! - A Beginner's Setup Tutorial
                  </a></li>
                  
                  <li><a href="/2016/08/30/exploring-typescript/">
                    Exploring TypeScript
                  </a></li>
                  
                  <li><a href="/2016/08/22/git-on-windows-whence-cometh-configuration/">
                    Git on Windows: Whence Cometh Configuration
                  </a></li>
                  
                  <li><a href="/2016/02/28/separation-of-concerns-application-builds-continuous-integration/">
                    Separation of Concerns: Application Builds & Continuous Integration
                  </a></li>
                  
                  <li><a href="/2015/11/01/survey-of-entity-framework-unit-of-work-patterns/">
                    Survey of Entity Framework Unit of Work Patterns
                  </a></li>
                  
                  <li><a href="/2015/03/08/introducing-nunit-specifications/">
                    Introducing NUnit.Specifications
                  </a></li>
                  
                  <li><a href="/2014/03/05/being-agile/">
                    Being Agile
                  </a></li>
                  
                  <li><a href="/2013/11/17/expected-objects-custom-comparisons/">
                    Expected Objects Custom Comparisons
                  </a></li>
                  
                  <li><a href="/2013/04/17/rabbitbus-an-example/">
                    RabbitBus: An Example
                  </a></li>
                  
                  <li><a href="/2013/01/27/adventures-in-debugging-the-nhibernate-dont-flush-the-session-error/">
                    Adventures in Debugging: The NHibernate 'don't flush the Session' Error
                  </a></li>
                  
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="tile is-child widget">
            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recommended Websites
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <ul>
                    <li>
                      <a href="https://lostechies.com">Los Techies</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>
</div>

<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>
      <a class="icon" href="https://github.com/derekgreer">
          <i class="fa fa-github" title="Github"></i>
        </a>
        <a class="icon" href="https://in.linkedin.com/in/derekgreer">
          <i class="fa fa-linkedin" title="Linkedin"></i>
        </a>
        <a class="icon" href="mailto:dbgreer@gmail.com">
          <i class="fa fa-envelope" title="Email"></i>
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- js -->
<script src="/assets/js/custom.js"></script>
<script src="/assets/js/typewriter.js"></script>
</body>
</html>
